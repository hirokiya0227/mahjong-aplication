<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éº»é›€ç‚¹æ•°ãƒœãƒ¼ãƒ‰</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
      background: #f5f5f5;
    }
    h1 {
      font-size: 18px;
      text-align: center;
      margin: 0 0 10px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      flex-wrap: wrap;
      margin-bottom:50px
    }
    select, button, input[type="radio"] {
      font-size: 14px;
    }

    #boardWrapper {
      position: relative;
      width: 100%;
      max-width: 420px;
      margin: 0 auto 10px;
    }

    #table {
      width: 100%;
      aspect-ratio: 1 / 1;
      position: relative;
      background: #e0e0e0;
      border-radius: 16px;
      padding: 8px;
      box-sizing: border-box;
    }

    .seat {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 110px;
      padding: 8px;
      box-sizing: border-box;
      background: #ffffffdd;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
      transform-origin: center;
    }
    .seat.winner {
      border-color: #ff5722;
      box-shadow: 0 0 6px #ff5722aa;
    }

    /* 4æ–¹å‘ã®ä½ç½®ï¼‹ãƒ–ãƒ­ãƒƒã‚¯ã®å‘ã */
    .seat-top {
      top: 4px;
      left: 50%;
      transform: translateX(-50%) rotate(180deg);
    }
    .seat-bottom {
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%) rotate(0deg);
    }
    .seat-left {
      left: -10px;
      top: 50%;
      transform: translateY(-50%) rotate(90deg);
    }
    .seat-right {
      right: -10px;
      top: 50%;
      transform: translateY(-50%) rotate(-90deg);
    }

    .player-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      margin-bottom: 4px;
    }
    .player-header select {
      max-width: 110px;
    }

    .name-view {
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
      display: none;
    }

    .dealer-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .dealer-label {
      font-size: 12px;
    }

    .score {
      font-size: 24px;
      font-weight: bold;
      line-height: 1.1;
    }

    /* æœ¬å ´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ï¼ˆå“ä¸­å¤®ï¼‰ */
    #centerHonba {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffffee;
      border-radius: 10px;
      padding: 4px 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid #ccc;
      z-index: 5;
    }
    #centerHonba button {
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #eee;
      color: #333;
      font-size: 11px;
    }

    /* ãƒªãƒ¼ãƒæ£’è¡¨ç¤ºï¼ˆæœ¬å ´ã®ä¸‹ï¼‰ */
    #reachPool {
      position: absolute;
      top: calc(50% + 18px);
      left: 50%;
      transform: translate(-50%, 0);
      background: #ffffffee;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 12px;
      border: 1px solid #ccc;
      z-index: 5;
    }

    /* æµå±€ãƒœã‚¿ãƒ³ï¼ˆãƒªãƒ¼ãƒæ£’ã®ã•ã‚‰ã«ä¸‹ï¼‰ */
    #ryuukyokuBtnBox {
      position: absolute;
      top: calc(50% + 36px);
      left: 50%;
      transform: translate(-50%, 0);
      z-index: 5;
    }
    #ryuukyokuBtnBox button {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #eee;
      color: #333;
      font-size: 15px;
      margin-top:10px
    }

    /* æµå±€ãƒ‘ãƒãƒ« */
    #ryuukyokuPanel {
      position: absolute;
      left: 50%;
      top: 60%;
      transform: translate(-50%, 0);
      background: #ffffffee;
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      border: 1px solid #ccc;
      z-index: 6;
      display: none;
      max-width: 90%;
      box-sizing: border-box;
    }
    #ryuukyokuPanel h3 {
      margin: 0 0 4px;
      font-size: 13px;
    }
    #tenpaiCheckboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 8px;
      margin-bottom: 4px;
    }
    #ryuukyokuPanel button {
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #eee;
      color: #333;
      font-size: 11px;
      margin-right: 4px;
    }

    /* è¨­å®šãƒ‘ãƒãƒ«ï¼šå“ã®ä¸‹ã«å›ºå®šï¼ˆå›è»¢ãªã—ï¼‰ */
    .input-panel {
      max-width: 420px;
      margin: 0 auto 10px;
      background: #fff;
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 2px 4px #00000033;
      font-size: 14px;
      box-sizing: border-box;
    }

    .field {
      margin-bottom: 6px;
    }
    .field label {
      margin-right: 8px;
    }
    #winnerDisplay {
      font-size: 13px;
      margin-bottom: 6px;
    }

    #log {
      max-width: 420px;
      margin: 0 auto;
      max-height: 120px;
      overflow-y: auto;
      font-size: 11px;
      border-top: 1px solid #ddd;
      padding-top: 4px;
    }
    #log div {
      margin-bottom: 2px;
    }

    button.main-btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      background: #4caf50;
      color: white;
      font-weight: bold;
    }
    button.main-btn:active {
      opacity: 0.8;
    }
    button.secondary-btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      background: #ff9800;
      color: white;
      font-weight: bold;
    }
    button.secondary-btn:active {
      opacity: 0.8;
    }
    button.small-btn {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #eee;
      color: #333;
      font-size: 12px;
    }

    /* ãƒªãƒ¼ãƒãƒœã‚¿ãƒ³ï¼ˆç™½ãƒ–ãƒ­ãƒƒã‚¯ã®æ¨ªï¼‰ */
    .reach-btn {
      position: absolute;
      width: 48px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid #666;
      background: #fff;
      color: #666;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      z-index: 4;
    }
    .reach-btn.active-reach {
      background: #ff5252;
      color: #fff;
      border-color: #ff5252;
    }

    /* å„å¸­ã”ã¨ã®ãƒªãƒ¼ãƒãƒœã‚¿ãƒ³ã®ä½ç½®ï¼ˆç™½ãƒ–ãƒ­ãƒƒã‚¯ã®å¤–å´æ¨ªï¼‰ */
    .reach-top {
      top: 12px;
      left: calc(50% + 70px);
      transform: translateX(-50%);
      transform: rotate(180deg);
    }
    .reach-bottom {
      bottom: 12px;
      left: calc(50% - 90px);
      transform: translateX(-50%);
    }
    .reach-left {
      left: 16px;
      top: calc(50% + -115px);
      transform: translateY(-50%);
      transform: rotate(90deg);
    }
    .reach-right {
      right: 16px;
      top: calc(50% - -70px);
      transform: translateY(-50%);
      transform: rotate(270deg);
    }

    /* ===== è¿½åŠ ï¼šè¦ªã®è™¹è‰² / ä½ã‚¹ã‚³ã‚¢èµ¤ ===== */
    .seat.dealer-seat {
      background: linear-gradient(90deg,
        #ff1744, #ff9100, #ffee00, #00e676, #00b0ff, #651fff, #d500f9
      );
      border-color: #8e24aa;
      box-shadow: 0 0 10px #8e24aa66;
    }

    .seat.low-score {
      background: #ffebee;
      border-color: #f44336;
      box-shadow: 0 0 8px #f4433666;
    }

    .seat.dealer-seat.low-score {
      background: linear-gradient(90deg,
        #ff1744, #ff9100, #ffee00, #00e676, #00b0ff, #651fff, #d500f9
      );
      border-color: #f44336;
      box-shadow: 0 0 10px #f4433666;
    }
  </style>
</head>
<body>
  <h1>éº»é›€ç‚¹æ•°ãƒœãƒ¼ãƒ‰</h1>

  <div class="controls">
    <div>
      äººæ•°ï¼š
      <select id="playerCount">
        <option value="4">4äºº</option>
        <option value="3">3äºº</option>
      </select>
    </div>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      <button type="button" id="shuffleSeatsBtn" class="small-btn">å¸­æ›¿ãˆ</button>
      <button type="button" id="resetScoresBtn" class="small-btn">ç‚¹æ•°ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    <div>â€»å“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œä¸ŠãŒã‚Šã€ã‚’é¸æŠ</div>
  </div>

  <div id="boardWrapper">
    <div id="table">
      <!-- æœ¬å ´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ï¼ˆå“ä¸­å¤®ï¼‰ -->
      <div id="centerHonba">
        <span>æœ¬å ´</span>
        <button type="button" id="honbaMinus">âˆ’</button>
        <span id="honbaCount">0</span><span>æœ¬</span>
        <button type="button" id="honbaPlus">ï¼‹</button>
        <button type="button" id="honbaReset">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <!-- ãƒªãƒ¼ãƒæ£’è¡¨ç¤º -->
      <div id="reachPool">
        ãƒªãƒ¼ãƒæ£’ï¼š<span id="reachCount">0</span> æœ¬
      </div>

      <!-- æµå±€ãƒœã‚¿ãƒ³ -->
      <div id="ryuukyokuBtnBox">
        <button type="button" id="ryuukyokuBtn">æµå±€</button>
      </div>

      <!-- æµå±€ç”¨ãƒ‘ãƒãƒ« -->
      <div id="ryuukyokuPanel">
        <h3>æµå±€ï¼šãƒ†ãƒ³ãƒ‘ã‚¤ã—ã¦ã„ã‚‹äººã‚’é¸æŠ</h3>
        <div id="tenpaiCheckboxes"></div>
        <div>
          <button type="button" id="ryuukyokuApply">ç‚¹æ•°ç²¾ç®—</button>
          <button type="button" id="ryuukyokuCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>

      <!-- 0: ä¸Š -->
      <div class="seat seat-top" data-index="0">
        <div class="player-header">
          <select class="name-select"></select>
          <div class="name-view"></div>
          <div class="dealer-row">
            <label class="dealer-label">
              <input type="radio" name="dealer" class="dealer-radio">
              è¦ª
            </label>
          </div>
        </div>
        <div class="score" data-score-index="0">25000</div>
      </div>
      <button type="button" class="reach-btn reach-top" data-index="0">ãƒªãƒ¼ãƒ</button>

      <!-- 1: å³ -->
      <div class="seat seat-right" data-index="1">
        <div class="player-header">
          <select class="name-select"></select>
          <div class="name-view"></div>
          <div class="dealer-row">
            <label class="dealer-label">
              <input type="radio" name="dealer" class="dealer-radio">
              è¦ª
            </label>
          </div>
        </div>
        <div class="score" data-score-index="1">25000</div>
      </div>
      <button type="button" class="reach-btn reach-right" data-index="1">ãƒªãƒ¼ãƒ</button>

      <!-- 2: ä¸‹ -->
      <div class="seat seat-bottom" data-index="2">
        <div class="player-header">
          <select class="name-select"></select>
          <div class="name-view"></div>
          <div class="dealer-row">
            <label class="dealer-label">
              <input type="radio" name="dealer" class="dealer-radio" checked>
              è¦ª
            </label>
          </div>
        </div>
        <div class="score" data-score-index="2">25000</div>
      </div>
      <button type="button" class="reach-btn reach-bottom" data-index="2">ãƒªãƒ¼ãƒ</button>

      <!-- 3: å·¦ï¼ˆ3äººã®ã¨ãã¯éè¡¨ç¤ºï¼‰ -->
      <div class="seat seat-left" data-index="3">
        <div class="player-header">
          <select class="name-select"></select>
          <div class="name-view"></div>
          <div class="dealer-row">
            <label class="dealer-label">
              <input type="radio" name="dealer" class="dealer-radio">
              è¦ª
            </label>
          </div>
        </div>
        <div class="score" data-score-index="3">25000</div>
      </div>
      <button type="button" class="reach-btn reach-left" data-index="3">ãƒªãƒ¼ãƒ</button>
    </div>
  </div>

  <!-- å“ã®ä¸‹ã«å›ºå®šã®è¨­å®šãƒ‘ãƒãƒ«ï¼ˆãƒ„ãƒ¢/ãƒ­ãƒ³é¸æŠã‚’å¾©æ´»ï¼‰ -->
  <div class="input-panel" id="inputPanel">
    <div class="input-inner">
      <div id="winnerDisplay">ä¸ŠãŒã£ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å“ã‹ã‚‰ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</div>

      <div class="field">
        <span>ä¸ŠãŒã‚Šã‚¿ã‚¤ãƒ—ï¼š</span>
        <label><input type="radio" name="agariType" value="tsumo" checked>ãƒ„ãƒ¢</label>
        <label><input type="radio" name="agariType" value="ron">ãƒ­ãƒ³</label>
      </div>

      <div class="field" id="loserField" style="display:none;">
        <label>æ”¾éŠƒè€…ï¼š
          <select id="loserSelect"></select>
        </label>
      </div>

      <div class="field">
        <label>ç‚¹æ•°ï¼ˆå­ / è¦ªï¼‰ï¼š
          <select id="scoreSelect">
            <option value="">ä¸ŠãŒã‚Šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨è¦ªã‚’é¸ã¶ã¨å€™è£œãŒå‡ºã¾ã™</option>
          </select>
        </label>
      </div>

      <div class="field" style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="main-btn" id="applyBtn">ç‚¹æ•°ã‚’åæ˜ </button>
        <button class="secondary-btn" id="undoBtn">1ã¤æˆ»ã™</button>
        <button class="secondary-btn" id="redoBtn">1ã¤é€²ã‚€</button>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <script>
    const NAME_OPTIONS = [
      "ã‚†ã†ã‚","ã²ã‚ã","ãƒ¦ã‚¦ã‚¿","ã¾ã•ã","ã—ã‚“ã”","ã—ã‚“ã¡ã‚ƒã‚“","ã—ã‚…ã†ã˜ã‚ã†","ãŸã‹ã—"
    ];

    const INITIAL_POINTS_FOUR = 25000;
    const INITIAL_POINTS_THREE = 35000;

    const CHILD_SCORES = [
      { id: "c1",  label: "1000 (ãƒ„ãƒ¢: å­200 / è¦ª600)",    ron: 1000,  tsumoChild: 200,   tsumoParent: 600 },
      { id: "c2",  label: "2000 (ãƒ„ãƒ¢: å­500 / è¦ª1000)",   ron: 2000,  tsumoChild: 500,   tsumoParent: 1000 },
      { id: "c3",  label: "3900 (ãƒ„ãƒ¢: å­1000 / è¦ª2000)",  ron: 3900,  tsumoChild: 1000,  tsumoParent: 2000 },
      { id: "c4",  label: "8000 (ãƒ„ãƒ¢: å­2000 / è¦ª4000)",  ron: 8000,  tsumoChild: 2000,  tsumoParent: 4000 },
      { id: "c5",  label: "12000 (ãƒ„ãƒ¢: å­3000 / è¦ª6000)", ron: 12000, tsumoChild: 3000,  tsumoParent: 6000 },
      { id: "c6",  label: "16000 (ãƒ„ãƒ¢: å­4000 / è¦ª8000)", ron: 16000, tsumoChild: 4000,  tsumoParent: 8000 },
      { id: "c7",  label: "24000 (ãƒ„ãƒ¢: å­6000 / è¦ª12000)",ron: 24000, tsumoChild: 6000,  tsumoParent: 12000 },
      { id: "c8",  label: "32000 (ãƒ„ãƒ¢: å­8000 / è¦ª16000)",ron: 32000, tsumoChild: 8000,  tsumoParent: 16000 },
      { id: "c9",  label: "64000 (ãƒ„ãƒ¢: å­16000 / è¦ª32000)",ron:64000, tsumoChild: 16000, tsumoParent: 32000 }
    ];

    const PARENT_SCORES = [
      { id: "p1",  label: "2000 (ãƒ„ãƒ¢: 700ã‚ªãƒ¼ãƒ«)",    ron: 2000,  tsumoAll: 700 },
      { id: "p2",  label: "3900 (ãƒ„ãƒ¢: 1300ã‚ªãƒ¼ãƒ«)",   ron: 3900,  tsumoAll: 1300 },
      { id: "p3",  label: "5800 (ãƒ„ãƒ¢: 2000ã‚ªãƒ¼ãƒ«)",   ron: 5800,  tsumoAll: 2000 },
      { id: "p4",  label: "12000 (ãƒ„ãƒ¢: 4000ã‚ªãƒ¼ãƒ«)",  ron: 12000, tsumoAll: 4000 },
      { id: "p5",  label: "18000 (ãƒ„ãƒ¢: 6000ã‚ªãƒ¼ãƒ«)",  ron: 18000, tsumoAll: 6000 },
      { id: "p6",  label: "24000 (ãƒ„ãƒ¢: 8000ã‚ªãƒ¼ãƒ«)",  ron: 24000, tsumoAll: 8000 },
      { id: "p7",  label: "36000 (ãƒ„ãƒ¢: 12000ã‚ªãƒ¼ãƒ«)", ron: 36000, tsumoAll: 12000 },
      { id: "p8",  label: "48000 (ãƒ„ãƒ¢: 16000ã‚ªãƒ¼ãƒ«)", ron: 48000, tsumoAll: 16000 },
      { id: "p9",  label: "96000 (ãƒ„ãƒ¢: 32000ã‚ªãƒ¼ãƒ«)", ron: 96000, tsumoAll: 32000 }
    ];

    let playerCount = 4;
    let players = [];
    let winnerIndex = null;
    let honbaCount = 0;

    const playerCountSelect = document.getElementById("playerCount");
    const shuffleSeatsBtn = document.getElementById("shuffleSeatsBtn");
    const resetScoresBtn = document.getElementById("resetScoresBtn");
    const seats = document.querySelectorAll(".seat");
    const nameSelects = document.querySelectorAll(".name-select");
    const nameViews = document.querySelectorAll(".name-view");
    const dealerRadios = document.querySelectorAll(".dealer-radio");
    const scoreElems = document.querySelectorAll(".score");
    const winnerDisplay = document.getElementById("winnerDisplay");
    const agariTypeRadios = document.querySelectorAll("input[name='agariType']");
    const loserField = document.getElementById("loserField");
    const loserSelect = document.getElementById("loserSelect");
    const scoreSelect = document.getElementById("scoreSelect");
    const applyBtn = document.getElementById("applyBtn");
    const undoBtn = document.getElementById("undoBtn");
    const redoBtn = document.getElementById("redoBtn");
    const logDiv = document.getElementById("log");
    const honbaMinusBtn = document.getElementById("honbaMinus");
    const honbaPlusBtn = document.getElementById("honbaPlus");
    const honbaResetBtn = document.getElementById("honbaReset");
    const honbaCountSpan = document.getElementById("honbaCount");

    const ryuukyokuBtn = document.getElementById("ryuukyokuBtn");
    const ryuukyokuPanel = document.getElementById("ryuukyokuPanel");
    const tenpaiCheckboxesDiv = document.getElementById("tenpaiCheckboxes");
    const ryuukyokuApplyBtn = document.getElementById("ryuukyokuApply");
    const ryuukyokuCancelBtn = document.getElementById("ryuukyokuCancel");

    const reachCountSpan = document.getElementById("reachCount");
    const reachButtons = document.querySelectorAll(".reach-btn");

    // ğŸ” ã‚¢ãƒ³ãƒ‰ã‚¥ãƒ»ãƒªãƒ‰ã‚¥ç”¨å±¥æ­´
    let history = [];
    let future = [];

    // ãƒªãƒ¼ãƒçŠ¶æ…‹
    let reachFlags = [false, false, false, false];
    let reachSticks = 0;

    function saveState() {
      const state = {
        players: JSON.parse(JSON.stringify(players)),
        honba: honbaCount,
        dealer: getDealerIndex(),
        winnerIndex: winnerIndex,
        logHtml: logDiv.innerHTML,
        reachFlags: [...reachFlags],
        reachSticks: reachSticks,
        agariType: getCurrentAgariType(),
        loserSelected: loserSelect.value
      };
      history.push(state);
      future = [];
    }

    function applyFullState(st) {
      players = JSON.parse(JSON.stringify(st.players));
      honbaCount = st.honba;
      winnerIndex = st.winnerIndex;
      reachFlags = st.reachFlags ? [...st.reachFlags] : [false, false, false, false];
      reachSticks = st.reachSticks || 0;

      dealerRadios.forEach(r => r.checked = false);
      const dealerRadio = document.querySelector(`.seat[data-index="${st.dealer}"] .dealer-radio`);
      if (dealerRadio) dealerRadio.checked = true;

      // ä¸ŠãŒã‚Šã‚¿ã‚¤ãƒ—å¾©å…ƒ
      agariTypeRadios.forEach(r => r.checked = (r.value === (st.agariType || "tsumo")));

      renderScores();
      honbaCountSpan.textContent = honbaCount;

      clearWinnerHighlight();
      if (winnerIndex !== null && winnerIndex < playerCount) {
        const seat = document.querySelector(`.seat[data-index="${winnerIndex}"]`);
        if (seat) seat.classList.add("winner");
      }

      logDiv.innerHTML = st.logHtml || "";
      refreshNamesFromPlayers();
      updateReachUI();
      updateWinnerText();
      updateLoserOptions();
      updateScoreOptions();

      // æ”¾éŠƒè€…ã®é¸æŠå¾©å…ƒï¼ˆå€™è£œç”Ÿæˆå¾Œï¼‰
      if (st.loserSelected !== undefined && st.loserSelected !== null) {
        loserSelect.value = st.loserSelected;
      }

      updateSeatStyles();
    }

    function restoreState() {
      if (history.length === 0) return;

      const current = {
        players: JSON.parse(JSON.stringify(players)),
        honba: honbaCount,
        dealer: getDealerIndex(),
        winnerIndex: winnerIndex,
        logHtml: logDiv.innerHTML,
        reachFlags: [...reachFlags],
        reachSticks: reachSticks,
        agariType: getCurrentAgariType(),
        loserSelected: loserSelect.value
      };
      future.push(current);

      const prev = history.pop();
      applyFullState(prev);
    }

    function redoState() {
      if (future.length === 0) return;

      const current = {
        players: JSON.parse(JSON.stringify(players)),
        honba: honbaCount,
        dealer: getDealerIndex(),
        winnerIndex: winnerIndex,
        logHtml: logDiv.innerHTML,
        reachFlags: [...reachFlags],
        reachSticks: reachSticks,
        agariType: getCurrentAgariType(),
        loserSelected: loserSelect.value
      };
      history.push(current);

      const next = future.pop();
      applyFullState(next);
    }

    function initPlayers() {
      players = [];
      for (let i = 0; i < 4; i++) {
        players.push({ name: NAME_OPTIONS[i] || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`, score: INITIAL_POINTS_FOUR });
      }
      players.forEach((p, i) => { scoreElems[i].textContent = p.score; });
    }

    function initNameSelects() {
      nameSelects.forEach((sel, i) => {
        sel.innerHTML = "";
        NAME_OPTIONS.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        sel.value = players[i].name;
        if (nameViews[i]) nameViews[i].textContent = players[i].name;

        const stop = (e) => e.stopPropagation();
        sel.addEventListener("click", stop);
        sel.addEventListener("touchstart", stop);
        sel.addEventListener("mousedown", stop);

        sel.addEventListener("change", () => {
          players[i].name = sel.value;
          if (nameViews[i]) nameViews[i].textContent = sel.value;
          updateWinnerText();
          updateLoserOptions();
        });
      });
    }

    function refreshNamesFromPlayers() {
      nameSelects.forEach((sel, i) => {
        sel.value = players[i].name;
        if (nameViews[i]) nameViews[i].textContent = players[i].name;
      });
    }

    function getDealerIndex() {
      for (let i = 0; i < dealerRadios.length; i++) {
        if (dealerRadios[i].checked) {
          const seat = dealerRadios[i].closest(".seat");
          if (!seat) continue;
          const idx = parseInt(seat.dataset.index, 10);
          if (idx < playerCount) return idx;
        }
      }
      return 0;
    }

    function updateSeatStyles() {
      const dealerIdx = getDealerIndex();
      const lowThreshold = (playerCount === 3) ? 18000 : 12000;

      seats.forEach((seat, idx) => {
        if (idx >= playerCount) {
          seat.classList.remove("dealer-seat", "low-score");
          return;
        }

        if (idx === dealerIdx) seat.classList.add("dealer-seat");
        else seat.classList.remove("dealer-seat");

        if (players[idx].score < lowThreshold) seat.classList.add("low-score");
        else seat.classList.remove("low-score");
      });
    }

    function updatePlayerCount() {
      playerCount = parseInt(playerCountSelect.value, 10);

      seats.forEach((seat, idx) => {
        if (idx < playerCount) {
          seat.style.display = "flex";
        } else {
          seat.style.display = "none";
          const radio = seat.querySelector(".dealer-radio");
          if (radio) radio.checked = false;
        }
      });

      reachButtons.forEach(btn => {
        const idx = parseInt(btn.dataset.index, 10);
        btn.style.display = idx < playerCount ? "flex" : "none";
      });

      const dealerIdx = getDealerIndex();
      if (dealerIdx >= playerCount) dealerRadios[0].checked = true;

      if (winnerIndex !== null && winnerIndex >= playerCount) winnerIndex = null;
      clearWinnerHighlight();

      if (playerCount === 3) {
        let allActive25000 = true;
        for (let i = 0; i < 3; i++) {
          if (players[i].score !== INITIAL_POINTS_FOUR) { allActive25000 = false; break; }
        }
        if (allActive25000) for (let i = 0; i < 3; i++) players[i].score = INITIAL_POINTS_THREE;
      } else {
        let allActive35000 = true;
        for (let i = 0; i < 4; i++) {
          if (players[i].score !== INITIAL_POINTS_THREE) { allActive35000 = false; break; }
        }
        if (allActive35000) for (let i = 0; i < 4; i++) players[i].score = INITIAL_POINTS_FOUR;
      }

      renderScores();
      updateReachUI();
      updateWinnerText();
      updateLoserOptions();
      updateScoreOptions();
      updateSeatStyles();
    }

    function clearWinnerHighlight() { seats.forEach(seat => seat.classList.remove("winner")); }

    function setWinner(index) {
      if (index >= playerCount) return;
      winnerIndex = index;

      clearWinnerHighlight();
      seats.forEach(seat => {
        if (parseInt(seat.dataset.index, 10) === index) seat.classList.add("winner");
      });

      updateWinnerText();
      updateLoserOptions();
      updateScoreOptions();
    }

    function updateWinnerText() {
      if (winnerIndex === null) {
        winnerDisplay.textContent = "ä¸ŠãŒã£ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å“ã‹ã‚‰ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚";
      } else {
        const dealerIdx = getDealerIndex();
        const isDealer = dealerIdx === winnerIndex;
        winnerDisplay.textContent =
          `ä¸ŠãŒã‚Šï¼š${players[winnerIndex].name}ï¼ˆ${isDealer ? "è¦ª" : "å­"}ï¼‰ / æœ¬å ´ï¼š${honbaCount}æœ¬ / ãƒªãƒ¼ãƒæ£’ï¼š${reachSticks}æœ¬`;
      }
    }

    function getCurrentAgariType() {
      let val = "tsumo";
      agariTypeRadios.forEach(r => { if (r.checked) val = r.value; });
      return val;
    }

    function updateLoserOptions() {
      const agariType = getCurrentAgariType();
      if (agariType === "ron" && winnerIndex !== null) {
        loserField.style.display = "block";
        loserSelect.innerHTML = "";
        for (let i = 0; i < playerCount; i++) {
          if (i === winnerIndex) continue;
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = players[i].name;
          loserSelect.appendChild(opt);
        }
      } else {
        loserField.style.display = "none";
        loserSelect.innerHTML = "";
      }
    }

    function updateScoreOptions() {
      if (winnerIndex === null) {
        scoreSelect.innerHTML = `<option value="">ä¸ŠãŒã‚Šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨è¦ªã‚’é¸ã‚“ã§ãã ã•ã„</option>`;
        return;
      }

      const dealerIdx = getDealerIndex();
      const isDealer = dealerIdx === winnerIndex;

      scoreSelect.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "ç‚¹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„";
      scoreSelect.appendChild(opt0);

      const group = document.createElement("optgroup");
      group.label = isDealer ? "è¦ªã®ã‚ãŒã‚Š" : "å­ã®ã‚ãŒã‚Š";

      (isDealer ? PARENT_SCORES : CHILD_SCORES).forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.label;
        group.appendChild(opt);
      });
      scoreSelect.appendChild(group);
    }

    function findScoreById(id) {
      let s = CHILD_SCORES.find(x => x.id === id);
      if (s) return s;
      return PARENT_SCORES.find(x => x.id === id);
    }

    function renderScores() {
      for (let i = 0; i < 4; i++) scoreElems[i].textContent = players[i].score;
      updateSeatStyles();
    }

    function addLog(text) {
      const div = document.createElement("div");
      div.textContent = text;
      logDiv.prepend(div);
    }

    function updateReachUI() {
      reachCountSpan.textContent = reachSticks;
      reachButtons.forEach(btn => {
        const idx = parseInt(btn.dataset.index, 10);
        const active = idx < playerCount && reachFlags[idx];
        if (active) btn.classList.add("active-reach");
        else btn.classList.remove("active-reach");
        btn.style.display = idx < playerCount ? "flex" : "none";
      });
    }

    function applyScore() {
      if (winnerIndex === null) { alert("å…ˆã«ä¸ŠãŒã‚Šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å“ã‹ã‚‰ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚"); return; }

      const scoreId = scoreSelect.value;
      if (!scoreId) { alert("ç‚¹æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      const agariType = getCurrentAgariType();
      const scoreInfo = findScoreById(scoreId);
      if (!scoreInfo) return;

      const dealerIdx = getDealerIndex();
      const isDealerWin = dealerIdx === winnerIndex;

      const totalHonbaBonus = honbaCount * 300;
      const payersCount = playerCount - 1;
      const perPayerHonba = (payersCount > 0) ? (totalHonbaBonus / payersCount) : 0;

      saveState();

      if (agariType === "ron") {
        const loserIdx = parseInt(loserSelect.value, 10);
        if (isNaN(loserIdx)) {
          alert("æ”¾éŠƒè€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          history.pop();
          return;
        }

        const base = scoreInfo.ron;
        const delta = base + totalHonbaBonus;
        players[winnerIndex].score += delta;
        players[loserIdx].score -= delta;

        let logText = `ãƒ­ãƒ³ï¼š${players[winnerIndex].name} +${delta} / ${players[loserIdx].name} -${delta}ï¼ˆåŸºæœ¬${base}`;
        if (honbaCount > 0) logText += ` + æœ¬å ´${honbaCount}æœ¬ã§${totalHonbaBonus}`;
        logText += "ï¼‰";
        addLog(logText);
      } else {
        if (isDealerWin) {
          let gain = 0;
          for (let i = 0; i < playerCount; i++) {
            if (i === winnerIndex) continue;
            const basePay = scoreInfo.tsumoAll;
            const pay = basePay + perPayerHonba;
            players[i].score -= pay;
            gain += pay;
          }
          players[winnerIndex].score += gain;

          let logText = `è¦ªãƒ„ãƒ¢ï¼š${players[winnerIndex].name} +${gain}ï¼ˆå­${playerCount-1}äºº Ã— åŸºæœ¬${scoreInfo.tsumoAll}`;
          if (honbaCount > 0) logText += ` + æœ¬å ´${honbaCount}æœ¬åˆ† åˆè¨ˆ${totalHonbaBonus}`;
          logText += "ï¼‰";
          addLog(logText);
        } else {
          let gain = 0;
          for (let i = 0; i < playerCount; i++) {
            if (i === winnerIndex) continue;
            const basePay = (i === dealerIdx) ? scoreInfo.tsumoParent : scoreInfo.tsumoChild;
            const pay = basePay + perPayerHonba;
            players[i].score -= pay;
            gain += pay;
          }
          players[winnerIndex].score += gain;

          let logText = `å­ãƒ„ãƒ¢ï¼š${players[winnerIndex].name} +${gain}ï¼ˆè¦ª/å­ã‹ã‚‰åŸºæœ¬æ”¯æ‰•ã„`;
          if (honbaCount > 0) logText += ` + æœ¬å ´${honbaCount}æœ¬åˆ† åˆè¨ˆ${totalHonbaBonus}`;
          logText += "ï¼‰";
          addLog(logText);
        }
      }

      // ãƒªãƒ¼ãƒæ£’å›å
      if (reachSticks > 0) {
        const pot = reachSticks * 1000;
        players[winnerIndex].score += pot;
        addLog(`ãƒªãƒ¼ãƒæ£’ ${reachSticks}æœ¬ï¼ˆ+${pot}ï¼‰ã‚’ ${players[winnerIndex].name} ãŒå›å`);
        reachSticks = 0;
        reachFlags = reachFlags.map(() => false);
        updateReachUI();
      }

      renderScores();
      updateWinnerText();
    }

    function openRyuukyokuPanel() {
      tenpaiCheckboxesDiv.innerHTML = "";
      for (let i = 0; i < playerCount; i++) {
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "2px";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = i;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(players[i].name));
        tenpaiCheckboxesDiv.appendChild(label);
      }
      ryuukyokuPanel.style.display = "block";
    }
    function closeRyuukyokuPanel() { ryuukyokuPanel.style.display = "none"; }

    function applyRyuukyoku() {
      const tenpaiIndices = [];
      const cbs = tenpaiCheckboxesDiv.querySelectorAll("input[type='checkbox']");
      cbs.forEach(cb => { if (cb.checked) tenpaiIndices.push(parseInt(cb.value, 10)); });

      if (tenpaiIndices.length === 0 || tenpaiIndices.length === playerCount) {
        addLog("æµå±€ï¼šç‚¹æ•°ç§»å‹•ãªã—ï¼ˆå…¨å“¡ãƒãƒ¼ãƒ†ãƒ³ or å…¨å“¡ãƒ†ãƒ³ãƒ‘ã‚¤ï¼‰");
        closeRyuukyokuPanel();

        // æµå±€å¾Œã¯ãƒªãƒ¼ãƒçŠ¶æ…‹ã ã‘ãƒªã‚»ãƒƒãƒˆï¼ˆæ£’ã¯å ´ã«æ®‹ã™ï¼‰
        reachFlags = reachFlags.map(() => false);
        updateReachUI();

        updateWinnerText();
        return;
      }

      saveState();

      const total = 3000;
      const nTenpai = tenpaiIndices.length;
      const nNoten = playerCount - nTenpai;

      const gainPerTenpai = Math.floor(total / nTenpai);
      const lossPerNoten = Math.floor(total / nNoten);

      const notenIndices = [];
      for (let i = 0; i < playerCount; i++) if (!tenpaiIndices.includes(i)) notenIndices.push(i);

      tenpaiIndices.forEach(i => { players[i].score += gainPerTenpai; });
      notenIndices.forEach(i => { players[i].score -= lossPerNoten; });

      renderScores();

      const tenpaiNames = tenpaiIndices.map(i => players[i].name).join(" / ");
      const notenNames = notenIndices.map(i => players[i].name).join(" / ");
      addLog(`æµå±€ï¼šãƒ†ãƒ³ãƒ‘ã‚¤ â†’ +${gainPerTenpai}ï¼ˆ${tenpaiNames}ï¼‰ / ãƒãƒ¼ãƒ†ãƒ³ â†’ -${lossPerNoten}ï¼ˆ${notenNames}ï¼‰`);

      // æµå±€å¾Œã¯ãƒªãƒ¼ãƒçŠ¶æ…‹ã ã‘ãƒªã‚»ãƒƒãƒˆï¼ˆæ£’ã¯å ´ã«æ®‹ã™ï¼‰
      reachFlags = reachFlags.map(() => false);
      updateReachUI();

      closeRyuukyokuPanel();
      updateWinnerText();
    }

    function shuffleSeats() {
      saveState();

      const indices = [];
      for (let i = 0; i < playerCount; i++) indices.push(i);
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }

      const oldPlayers = players.slice();
      const oldReach = reachFlags.slice();
      const oldDealer = getDealerIndex();
      const oldWinner = winnerIndex;

      for (let i = 0; i < playerCount; i++) {
        players[i] = { ...oldPlayers[indices[i]] };
        reachFlags[i] = oldReach[indices[i]];
      }

      let newDealer = 0;
      for (let i = 0; i < playerCount; i++) if (indices[i] === oldDealer) { newDealer = i; break; }

      let newWinner = null;
      if (oldWinner !== null && oldWinner < playerCount) {
        for (let i = 0; i < playerCount; i++) if (indices[i] === oldWinner) { newWinner = i; break; }
      }

      dealerRadios.forEach(r => r.checked = false);
      const dealerRadio = document.querySelector(`.seat[data-index="${newDealer}"] .dealer-radio`);
      if (dealerRadio) dealerRadio.checked = true;
      winnerIndex = newWinner;

      renderScores();
      clearWinnerHighlight();
      if (winnerIndex !== null) {
        const seat = document.querySelector(`.seat[data-index="${winnerIndex}"]`);
        if (seat) seat.classList.add("winner");
      }

      refreshNamesFromPlayers();
      updateReachUI();
      updateWinnerText();
      updateLoserOptions();
      updateScoreOptions();
      updateSeatStyles();
      addLog("å¸­æ›¿ãˆã‚’å®Ÿè¡Œ");
    }

    function resetScores() {
      saveState();

      const initial = (playerCount === 3) ? INITIAL_POINTS_THREE : INITIAL_POINTS_FOUR;
      for (let i = 0; i < 4; i++) players[i].score = initial;

      honbaCount = 0;
      honbaCountSpan.textContent = honbaCount;
      reachSticks = 0;
      reachFlags = [false, false, false, false];
      clearWinnerHighlight();
      winnerIndex = null;

      updateReachUI();
      renderScores();
      updateWinnerText();
      updateLoserOptions();
      updateScoreOptions();
      addLog("ç‚¹æ•°ã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆ");
    }

    // â–¼ ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    seats.forEach(seat => {
      seat.addEventListener("click", () => {
        const idx = parseInt(seat.dataset.index, 10);
        setWinner(idx);
      });
    });

    // è¦ªå¤‰æ›´ï¼šæœ¬å ´è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ + è™¹è‰²æ›´æ–°
    dealerRadios.forEach(radio => {
      const stop = (e) => e.stopPropagation();
      radio.addEventListener("click", stop);
      radio.addEventListener("touchstart", stop);
      radio.addEventListener("mousedown", stop);

      radio.addEventListener("change", () => {
        // â˜… è¦ªå¤‰æ›´ã§æœ¬å ´ãƒªã‚»ãƒƒãƒˆ
        if (honbaCount !== 0) {
          saveState();
          honbaCount = 0;
          honbaCountSpan.textContent = honbaCount;
          addLog("è¦ªå¤‰æ›´ï¼šæœ¬å ´ã‚’ãƒªã‚»ãƒƒãƒˆ");
        }

        updateWinnerText();
        updateScoreOptions();
        updateSeatStyles();
      });
    });

    agariTypeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        updateLoserOptions();
      });
    });

    playerCountSelect.addEventListener("change", () => { updatePlayerCount(); });
    applyBtn.addEventListener("click", () => { applyScore(); });
    undoBtn.addEventListener("click", () => { restoreState(); });
    redoBtn.addEventListener("click", () => { redoState(); });

    honbaMinusBtn.addEventListener("click", () => {
      if (honbaCount > 0) {
        honbaCount--;
        honbaCountSpan.textContent = honbaCount;
        updateWinnerText();
      }
    });
    honbaPlusBtn.addEventListener("click", () => {
      honbaCount++;
      honbaCountSpan.textContent = honbaCount;
      updateWinnerText();
    });
    honbaResetBtn.addEventListener("click", () => {
      honbaCount = 0;
      honbaCountSpan.textContent = honbaCount;
      updateWinnerText();
    });

    ryuukyokuBtn.addEventListener("click", () => { openRyuukyokuPanel(); });
    ryuukyokuCancelBtn.addEventListener("click", () => { closeRyuukyokuPanel(); });
    ryuukyokuApplyBtn.addEventListener("click", () => { applyRyuukyoku(); });

    shuffleSeatsBtn.addEventListener("click", () => { shuffleSeats(); });
    resetScoresBtn.addEventListener("click", () => { resetScores(); });

    // ãƒªãƒ¼ãƒãƒœã‚¿ãƒ³ï¼ˆã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
    reachButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = parseInt(btn.dataset.index, 10);
        if (idx >= playerCount) return;

        saveState();

        if (!reachFlags[idx]) {
          if (players[idx].score < 1000) {
            alert("1000ç‚¹æœªæº€ã®ãŸã‚ãƒªãƒ¼ãƒã§ãã¾ã›ã‚“ã€‚");
            history.pop();
            return;
          }

          players[idx].score -= 1000;
          reachFlags[idx] = true;
          reachSticks += 1;
          addLog(`ãƒªãƒ¼ãƒï¼š${players[idx].name} -1000 / ãƒªãƒ¼ãƒæ£’ ${reachSticks}æœ¬`);
        } else {
          players[idx].score += 1000;
          reachFlags[idx] = false;
          if (reachSticks > 0) reachSticks -= 1;
          addLog(`ãƒªãƒ¼ãƒå–ã‚Šæ¶ˆã—ï¼š${players[idx].name} +1000 / ãƒªãƒ¼ãƒæ£’ ${reachSticks}æœ¬`);
        }

        renderScores();
        updateReachUI();
        updateWinnerText();
      });
    });

    // åˆæœŸåŒ–
    initPlayers();
    initNameSelects();
    updatePlayerCount();
    updateWinnerText();
    updateLoserOptions();
    updateScoreOptions();
    updateReachUI();
    updateSeatStyles();
  </script>
</body>
</html>
